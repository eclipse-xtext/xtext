/*
* generated by Xtext
*/
package org.eclipse.xtext.xbase.ui.labeling;

import org.eclipse.emf.edit.ui.provider.AdapterFactoryLabelProvider;
import org.eclipse.jface.viewers.StyledString;
import org.eclipse.swt.graphics.Image;
import org.eclipse.xtext.common.types.JvmAnnotationType;
import org.eclipse.xtext.common.types.JvmConstructor;
import org.eclipse.xtext.common.types.JvmEnumerationType;
import org.eclipse.xtext.common.types.JvmField;
import org.eclipse.xtext.common.types.JvmFormalParameter;
import org.eclipse.xtext.common.types.JvmGenericType;
import org.eclipse.xtext.common.types.JvmIdentifiableElement;
import org.eclipse.xtext.common.types.JvmOperation;
import org.eclipse.xtext.common.types.JvmTypeParameter;
import org.eclipse.xtext.common.types.JvmTypeReference;
import org.eclipse.xtext.ui.label.DefaultEObjectLabelProvider;
import org.eclipse.xtext.xbase.XAbstractFeatureCall;
import org.eclipse.xtext.xbase.XCasePart;
import org.eclipse.xtext.xbase.XSwitchExpression;
import org.eclipse.xtext.xbase.XVariableDeclaration;
import org.eclipse.xtext.xbase.typesystem.IBatchTypeResolver;
import org.eclipse.xtext.xbase.typesystem.IResolvedTypes;
import org.eclipse.xtext.xbase.typesystem.references.LightweightTypeReference;
import org.eclipse.xtext.xbase.validation.UIStrings;
import org.eclipse.xtext.xtype.XImportDeclaration;
import org.eclipse.xtext.xtype.XImportSection;

import com.google.inject.Inject;

/**
 * see http://www.eclipse.org/Xtext/documentation/latest/xtext.html#labelProvider
 */
public class XbaseLabelProvider extends DefaultEObjectLabelProvider {
	
	@Inject
	private XbaseImages2 images;
	
	@Inject
	private UIStrings uiStrings;
	
	@Inject
	private IBatchTypeResolver typeResolver;
	
	@Inject
	private XbaseImageAdornments adornments;
	
	@Inject
	public XbaseLabelProvider(AdapterFactoryLabelProvider delegate) {
		super(delegate);
	}
	
	public Image image(XImportSection importSection) {
		return images.forImportContainer();
	}
	
	public Image image(XImportDeclaration importDeclaration) {
		return images.forImport();
	}
	
	public Image image(JvmGenericType genericType){
		if(genericType.isInterface())
			return images.forInterface(genericType.getVisibility(), adornments.get(genericType));
		else 
			return images.forClass(genericType.getVisibility(), adornments.get(genericType));
	}
	
	public Image image(JvmEnumerationType enumerationType){
		return images.forEnum(enumerationType.getVisibility(), adornments.get(enumerationType));
	}
	
	public Image image(JvmAnnotationType annotationType){
		return images.forAnnotation(annotationType.getVisibility(), adornments.get(annotationType));
	}
	
	public String text(JvmGenericType genericType){
		return genericType.getSimpleName();
	}
	
	public Image image(JvmOperation operation) {
		return images.forOperation(operation.getVisibility(), adornments.get(operation));
	}
	
	public Object text(JvmOperation element) {
		return signature(element.getSimpleName(), element);
	}

	public Image image(JvmConstructor constructor) {
		return images.forConstructor(constructor.getVisibility(), adornments.get(constructor));
	}
	
	public String text(JvmConstructor constructor) {
		return "new" + uiStrings.parameters(constructor);
	}
	
	public Image image(JvmField field) {
		return images.forField(field.getVisibility(), adornments.get(field));
	}
	
	public String text(JvmField field) {
		return field.getSimpleName() +" : " + field.getType().getSimpleName();
	}
	
	public Image image(JvmFormalParameter parameter) {
		return images.forLocalVariable(adornments.get(parameter));
	}
	
	public String text(JvmFormalParameter parameter){
		JvmTypeReference parameterType = parameter.getParameterType();
		String result = parameter.getName();
		if(parameterType != null)
			result =  parameterType.getSimpleName() + " " + result;
		return result;
	}
	
	public Image image(XVariableDeclaration variableDeclaration){
		return images.forLocalVariable(adornments.get(variableDeclaration));
	}
	
	public String text(XVariableDeclaration variableDeclaration){
		IResolvedTypes resolvedTypes = typeResolver.resolveTypes(variableDeclaration);
		LightweightTypeReference type = resolvedTypes.getActualType((JvmIdentifiableElement)variableDeclaration);
		String result = variableDeclaration.getName();
		if(type != null)
			result =  type.getSimpleName() + " " + result;
		return result;
	}
	
	public Image image(JvmTypeParameter parameter){
		return images.forTypeParameter(adornments.get(parameter));
	}

	public String text(XCasePart casePart){
		if (casePart.eContainer() instanceof XSwitchExpression) {
			XSwitchExpression switchExpression = (XSwitchExpression) casePart.eContainer();
			if (switchExpression != null) {
				if (switchExpression.getLocalVarName() != null)
					return switchExpression.getLocalVarName();
				if (switchExpression.getSwitch() instanceof XAbstractFeatureCall) {
					XAbstractFeatureCall call = (XAbstractFeatureCall) switchExpression.getSwitch();
					if (call.getFeature() != null)
						return call.getFeature().getSimpleName();
				}
			}
		}
		return null;
	}
	
	protected StyledString signature(String simpleName, JvmIdentifiableElement element) {
		IResolvedTypes resolvedTypes = typeResolver.resolveTypes(element);
		LightweightTypeReference returnType = resolvedTypes.getActualType(element);
		String returnTypeString = "void";
		if (returnType != null) {
			returnTypeString = returnType.getSimpleName();
		}
		return new StyledString(simpleName + uiStrings.parameters(element)).append(new StyledString(" : " + returnTypeString,StyledString.DECORATIONS_STYLER));
	}
}
